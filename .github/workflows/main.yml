name: Android Super Repack (Universal FS)

on:
  workflow_dispatch:
    inputs:
      device_preset:
        description: 'Select Stock Firmware Source'
        required: true
        default: 'none'
        type: choice
        options:
        - 'none (Use Custom URL below)'
        - 'Samsung A04s (64GB)'
        - 'Samsung A15 (128/256GB)'
      stock_firmware_url:
        description: 'Custom Stock Firmware URL (Required if preset is none)'
        required: false
        type: string
      custom_system_url:
        description: 'Custom ROM URL (LineageOS, etc.)'
        required: true
        type: string
      upload_to_release:
        description: 'Upload to Release?'
        required: true
        type: boolean
        default: false
      empty_product:
        description: 'Use empty product.img (-e)'
        required: false
        type: boolean
        default: true
      empty_system_ext:
        description: 'Use empty system_ext.img (-x)'
        required: false
        type: boolean
        default: true
      silent_mode:
        description: 'Silent mode (-s)'
        required: false
        type: boolean
        default: true
      writable:
        description: 'Make partitions writable (-w)'
        required: false
        type: boolean
        default: false

jobs:
  repack-super:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y android-sdk-libsparse-utils tar xz-utils liblz4-tool unzip p7zip-full file wget curl megatools f2fs-tools erofs-utils python3-pip
        pip install gdown
        curl -fsSL https://get-docker.com -o get-docker.sh
        sudo sh get-docker.sh

    - name: Verify and Prepare Script
      run: |
        if [ ! -f "./repacksuper.sh" ]; then echo "âœ— Error: repacksuper.sh not found" && exit 1; fi
        chmod +x ./repacksuper.sh
        mkdir -p work

    - name: Download Stock Firmware
      run: |
        cd work
        PRESET="${{ github.event.inputs.device_preset }}"
        if [[ "$PRESET" == "none (Use Custom URL below)" ]]; then
          FIRMWARE_URL="${{ github.event.inputs.stock_firmware_url }}"
          if [[ $FIRMWARE_URL == *"mega.nz"* ]]; then 
            megadl -o stock_firmware.zip "$FIRMWARE_URL"
          else 
            wget --content-disposition -O stock_firmware.zip "$FIRMWARE_URL"
          fi
        fi
        
        echo "==> Extracting AP file..."
        AP_FILENAME=$(unzip -l "stock_firmware.zip" | grep -i -o -E "AP_.*\.tar\.md5" | head -n 1)
        unzip -o -j "stock_firmware.zip" "$AP_FILENAME"
        
        echo "==> Extracting super.img.lz4..."
        tar -xvf "$AP_FILENAME" --wildcards '*super.img*.lz4'
        
        echo "==> Decompressing LZ4..."
        SUPER_LZ4=$(ls *super.img*.lz4 | head -n 1)
        lz4 -d "$SUPER_LZ4" stock_super_sparse.img

    - name: Download and Extract Custom System
      run: |
        cd work
        wget -O custom_rom_package "${{ github.event.inputs.custom_system_url }}"
        FILE_DESC=$(file -b custom_rom_package)
        if [[ "$FILE_DESC" == *"XZ compressed"* ]]; then
            unxz -c custom_rom_package > custom_system.img
        else
            mv custom_rom_package custom_system.img
        fi

    - name: Run Repack
      run: |
        # Force 4GB size for 32GB storage limit
        FIXED_SIZE=4294967296
        sed -i "s/block_device_table_size=\$retval/block_device_table_size=$FIXED_SIZE/g" repacksuper.sh
        sed -i "s/groups_max_size=\$retval/groups_max_size=$FIXED_SIZE/g" repacksuper.sh
        
        FLAGS="-r $(pwd)/work"
        if [ "${{ github.event.inputs.silent_mode }}" == "true" ]; then FLAGS="$FLAGS -s"; fi
        if [ "${{ github.event.inputs.empty_product }}" == "true" ]; then FLAGS="$FLAGS -e"; fi
        if [ "${{ github.event.inputs.empty_system_ext }}" == "true" ]; then FLAGS="$FLAGS -x"; fi
        
        # Calling the script directly without any 'cp' commands to avoid 'same file' errors
        ./repacksuper.sh $FLAGS work/stock_super_sparse.img work/custom_system.img work/repacked_super.img

    - name: Create Tarball
      run: |
        cd work
        mv repacked_super.img super.img
        tar -cvf "repacked_super.tar" super.img

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: repacked-super-image
        path: work/repacked_super.tar
